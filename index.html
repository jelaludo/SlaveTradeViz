<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scale of Slavery Throughout History</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #e0e0e0;
            padding: 20px;
            overflow-x: auto;
        }

        .container {
            max-width: 2400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            padding: 20px;
        }

        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 40px;
            font-size: 1.3rem;
            line-height: 1.6;
        }

        .stats-banner {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            padding: 0 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid;
            backdrop-filter: blur(10px);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }

        .stat-card .context {
            font-size: 0.95rem;
            color: #bbb;
            line-height: 1.4;
        }

        .visualization-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            position: relative;
            overflow-x: auto;
        }

        .timeline-svg {
            display: block;
            margin: 0 auto;
        }

        .flow-path {
            fill: none;
            stroke-opacity: 0.3;
            transition: stroke-opacity 0.3s, filter 0.3s;
        }

        .flow-path:hover {
            stroke-opacity: 0.9;
            filter: brightness(1.5);
        }

        .source-node, .dest-node {
            transition: all 0.3s;
            cursor: pointer;
        }

        .source-node:hover, .dest-node:hover {
            filter: brightness(1.3);
        }

        .node-label {
            fill: #fff;
            font-size: 11px;
            pointer-events: none;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        .trade-title {
            fill: #fff;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .axis text {
            fill: #ccc;
            font-size: 13px;
        }

        .axis line,
        .axis path {
            stroke: #666;
            stroke-width: 2;
        }

        .grid line {
            stroke: #333;
            stroke-opacity: 0.5;
            stroke-dasharray: 4,4;
        }

        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.95);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 350px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .tooltip strong {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #fff;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .detail-modal.visible {
            display: flex;
        }

        .detail-content {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .detail-content h2 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .detail-content p {
            line-height: 1.7;
            color: #ccc;
            margin-bottom: 15px;
        }

        .detail-content strong {
            color: #fff;
        }

        .close-modal-btn {
            float: right;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .close-modal-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        @media (max-width: 1400px) {
            h1 {
                font-size: 2rem;
            }
            .subtitle {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// Data embedded directly for immediate loading
const slaveryData = [
  {
    "id": "roman",
    "name": "Roman Empire",
    "period": "753 BCE - 476 CE",
    "color": "#14b8a6",
    "startYear": -753,
    "endYear": 476,
    "lowEstimate": 5000000,
    "highEstimate": 15000000,
    "flows": [
      { "source": "Gaul", "destination": "Italy", "value": 2000000 },
      { "source": "Germania", "destination": "Italy", "value": 1500000 },
      { "source": "Britain", "destination": "Italy", "value": 500000 },
      { "source": "North Africa", "destination": "Italy", "value": 1000000 },
      { "source": "Middle East", "destination": "Roman East", "value": 1200000 },
      { "source": "Balkans", "destination": "Italy", "value": 1500000 },
      { "source": "Various", "destination": "Provinces", "value": 2300000 }
    ],
    "description": "Slavery was fundamental to Roman society. Perhaps 10–30% of the Empire's population were enslaved at some point, concentrated in Italy and large provincial estates. People were enslaved through war, piracy, sale of children, exposure of infants, and penal slavery. Prisoners of war from Gaul, Germania, Britain and the East were sold into Italian markets, with some campaigns—like Caesar in Gaul or the First Punic War—generating tens of thousands of captives. Unlike later Atlantic systems, Roman slavery was not race-based but rooted in conquest, status and law.",
    "ending": "Roman slavery never disappeared overnight but eroded over centuries. As imperial expansion slowed in the 2nd–3rd centuries CE, the supply of war captives shrank. Legal reforms, Christian moral critiques, and economic changes pushed landowners to rely more on tenant farmers (coloni) bound to the land rather than chattel slaves. By the late Empire and in successor kingdoms, slavery shaded gradually into forms of serfdom, with fewer large-scale markets and more local dependence ties.",
    "destinationDetails": {
      "Italy": "Italy—especially Rome and central Italian estates—was the core sink for enslaved people captured across the Empire. They worked in latifundia agriculture, urban households, workshops, mines and public construction. Many household slaves could be manumitted and become freedpersons, but plantation and mine labor remained brutal.",
      "Roman East": "In the eastern provinces (Greece, Asia Minor, Syria, Egypt), slavery was deeply embedded in cities and villas. A larger share of enslaved people worked as skilled laborers, administrators, tutors and domestic servants, though agricultural and quarry work were also common. Eastern markets redistributed captives from frontier wars and piracy.",
      "Provinces": "Outside Italy and the major eastern centers, provincial estates, mines and households absorbed captives from local rebellions, frontier wars and debt. In Gaul, Spain, North Africa and the Balkans, some enslaved people never left their home region but were pulled into the Roman legal and economic system as property."
    }
  },
  {
    "id": "chinese-korean",
    "name": "Chinese & Korean Internal Slavery",
    "period": "1000 BCE - 1900 CE",
    "color": "#10b981",
    "startYear": -1000,
    "endYear": 1900,
    "lowEstimate": 20000000,
    "highEstimate": 30000000,
    "flows": [
      { "source": "Han Chinese", "destination": "Households", "value": 7000000 },
      { "source": "Han Chinese", "destination": "Estates", "value": 6000000 },
      { "source": "Han Chinese", "destination": "State Service", "value": 2000000 },
      { "source": "Ethnic Minorities", "destination": "Estates", "value": 4000000 },
      { "source": "Ethnic Minorities", "destination": "State Service", "value": 1000000 },
      { "source": "Korean Nobi", "destination": "Households", "value": 2000000 },
      { "source": "Korean Nobi", "destination": "Estates", "value": 1000000 }
    ],
    "description": "China and Korea sustained some of the world's oldest and largest internal enslavement systems. In China, slavery existed from the Shang dynasty through the Qing, including penal slaves, hereditary bondservants (jianmin), eunuchs, war captives, and debt slaves. In Korea, the nobi system enslaved up to 30% of the population in some periods.",
    "ending": "Abolition occurred through Qing reforms (1700s–1900s), Japanese colonial abolition in Korea (1894–1910), and global legal modernization. Systems eroded slowly rather than through a single legal decree.",
    "destinationDetails": {
      "Households": "Domestic slavery was widespread across Chinese and Korean households, with enslaved people serving as domestic servants, concubines, and personal attendants. Many were hereditary bondservants bound to families for generations.",
      "Estates": "Agricultural estates and plantations relied heavily on enslaved labor for rice cultivation, silk production, and other agricultural work. Enslaved people worked alongside tenant farmers in large-scale agricultural operations.",
      "State Service": "State and imperial service included eunuchs in imperial courts, penal slaves working on public projects, and administrative servitude. The eunuch system in particular had extremely high mortality rates."
    }
  },
  {
    "id": "pre-columbian",
    "name": "Pre-Columbian American Slavery",
    "period": "500 - 1500 CE",
    "color": "#f97316",
    "startYear": 500,
    "endYear": 1500,
    "lowEstimate": 3000000,
    "highEstimate": 5000000,
    "flows": [
      { "source": "Aztec Captives", "destination": "Ritual Slavery", "value": 700000 },
      { "source": "Aztec/Maya", "destination": "Agriculture & Construction", "value": 1000000 },
      { "source": "Inca Mit'a", "destination": "Infrastructure Labor", "value": 1000000 },
      { "source": "Inca Provinces", "destination": "Agriculture", "value": 500000 },
      { "source": "Amazonian Captives", "destination": "Domestic Slavery", "value": 500000 }
    ],
    "description": "The Americas had extensive systems of enslavement before European contact. The Aztecs used large numbers of war captives for ritual sacrifice; Maya city-states used slaves for warfare, agriculture, construction. The Inca mit'a system blurred lines between taxation, labor draft, and slavery. Amazonian groups practiced captive-taking as a central cultural institution.",
    "ending": "Collapse came through European conquest, epidemic depopulation, and conversion to colonial forced labor systems (encomienda, repartimiento). Some Amazonian systems persisted until the 19th century.",
    "destinationDetails": {
      "Ritual Slavery": "Aztec ritual slavery involved large numbers of war captives used for human sacrifice in religious ceremonies. Captives were often taken specifically for this purpose during wars of expansion.",
      "Agriculture & Construction": "Maya and Aztec city-states used enslaved people extensively for agricultural work, temple construction, and public works projects. Many were war captives or tribute populations.",
      "Infrastructure Labor": "The Inca mit'a system required labor service for imperial infrastructure including road construction, terrace farming, and public works. While technically a labor draft, it functioned as a form of forced servitude.",
      "Agriculture": "Inca provinces provided agricultural labor through the mit'a system, with workers maintaining terraced fields and producing food for the empire.",
      "Domestic Slavery": "Amazonian groups practiced captive-taking as a central cultural institution, with captives integrated into households and communities, often through adoption or marriage."
    }
  },
  {
    "id": "trans-saharan",
    "name": "Trans-Saharan Trade",
    "period": "650 - 1900 CE",
    "color": "#f59e0b",
    "startYear": 650,
    "endYear": 1900,
    "lowEstimate": 6000000,
    "highEstimate": 10000000,
    "flows": [
      { "source": "West Sudan", "destination": "Morocco", "value": 800000 },
      { "source": "West Sudan", "destination": "Algeria", "value": 300000 },
      { "source": "Central Sudan", "destination": "Libya", "value": 900000 },
      { "source": "Central Sudan", "destination": "Tunisia", "value": 400000 },
      { "source": "Central Sudan", "destination": "Ottoman Empire", "value": 2500000 },
      { "source": "East Sudan", "destination": "Egypt", "value": 1800000 },
      { "source": "Sahel", "destination": "North Africa", "value": 1500000 },
      { "source": "Various", "destination": "Middle East", "value": 1800000 }
    ],
    "description": "The Trans-Saharan trade linked West, Central and East Sudan to North Africa and the Middle East for over a millennium. Estimates suggest 6–10 million people, many of them women and children, were taken across the desert in caravans. Enslaved people worked as domestic servants, concubines, soldiers, oasis farmers and craftspeople in cities such as Cairo, Tunis, Fez and Tripoli. Mortality on desert crossings could be very high, and female captives were especially numerous in this system compared to the Atlantic trade.",
    "ending": "The Trans-Saharan slave trade declined gradually in the 19th and early 20th centuries. European conquest of North Africa and the Sahel disrupted caravan routes and imposed abolitionist laws; Ottoman reforms and Egyptian decrees formally banned slave trading; and new colonial border controls made large caravans harder to organize. Even after legal bans, forms of bondage and domestic slavery persisted in some Saharan and Sahelian societies well into the 20th century.",
    "destinationDetails": {
      "North Africa": "Across North Africa, enslaved people from West and Central Sudan labored in urban households, small workshops and agricultural estates. Cities such as Fez and Tlemcen relied on caravan routes bringing captives through oases like Timbuktu and Ghadames.",
      "Egypt": "Egypt was both a terminus and redistribution hub. Enslaved people worked in Cairo households and estates, in the army and in administrative roles. Nubia and Sudan supplied many captives to Egyptian markets, and some were marched onward to the Arabian Peninsula.",
      "Algeria": "Algerian cities such as Tlemcen and Algiers absorbed captives as domestic servants, artisans and rural laborers. Some West African captives were also re-exported towards the central Maghreb and the Ottoman world.",
      "Tunisia": "Tunis served as an important port and political center where enslaved people worked in elite households, workshops and agricultural domains. Caravans from the Sahara and Fezzan often converged on Tunisian markets.",
      "Libya": "Tripoli and other Libyan towns were key staging posts for desert caravans. Captives from the Sahel and central Sahara were sold into households, agriculture and service in Tripolitan coastal society or moved onward to the Ottoman Empire.",
      "Morocco": "Moroccan cities such as Marrakesh and Fez drew in enslaved people from caravan routes through the western Sahara. They were used in royal courts, urban households and irrigated agriculture.",
      "Ottoman Empire": "Some captives moving through North African ports were sent deeper into the Ottoman world—into Anatolia, the Levant and the Balkans—where they served in households, elite military units and rural estates.",
      "Middle East": "Beyond the formal Ottoman territories, desert and Red Sea routes brought enslaved Africans into Arabia and the broader Middle East, where they were integrated into domestic, pastoral and religious economies."
    }
  },
  {
    "id": "slavic",
    "name": "Slavic Slave Trade",
    "period": "600 - 1200 CE",
    "color": "#3b82f6",
    "startYear": 600,
    "endYear": 1200,
    "lowEstimate": 2000000,
    "highEstimate": 4000000,
    "flows": [
      { "source": "East Slavs", "destination": "Al-Andalus", "value": 500000 },
      { "source": "East Slavs", "destination": "North Africa", "value": 400000 },
      { "source": "East Slavs", "destination": "Middle East", "value": 350000 },
      { "source": "West Slavs", "destination": "Al-Andalus", "value": 350000 },
      { "source": "West Slavs", "destination": "Middle East", "value": 250000 },
      { "source": "West Slavs", "destination": "Byzantium", "value": 100000 },
      { "source": "South Slavs", "destination": "North Africa", "value": 300000 },
      { "source": "South Slavs", "destination": "Middle East", "value": 200000 },
      { "source": "South Slavs", "destination": "Byzantium", "value": 100000 },
      { "source": "Baltic/Finnic", "destination": "Middle East", "value": 100000 },
      { "source": "Baltic/Finnic", "destination": "Al-Andalus", "value": 100000 }
    ],
    "description": "The medieval Slavic slave trade connected Eastern and Central Europe to Islamic markets across the Mediterranean. Viking (Varangian) traders, the Khazar Khaganate, Bohemian merchants (Prague), and Venetian middlemen transported Slavic captives in large numbers. The very word \"slave\" derives from \"Slav\" because of the scale and visibility of this trade.",
    "ending": "Decline came through Christianization of Slavic regions, strengthening of early states (Poland, Kievan Rus', Hungary), and the collapse of the Khazar trade networks. Growing military order and fortified frontiers reduced raiding, and Islamic powers gradually shifted their slave sourcing elsewhere.",
    "destinationDetails": {
      "Al-Andalus": "Islamic Spain (Al-Andalus) was a major destination for Slavic captives, who were transported via Prague and Venice. They worked in households, agriculture, and as soldiers in Muslim armies.",
      "North Africa": "The Maghreb (North Africa) absorbed Slavic captives through Mediterranean trade routes. They worked in urban households, agricultural estates, and as domestic servants.",
      "Middle East": "The Abbasid Caliphate and other Middle Eastern powers received Slavic captives through Khazar and Byzantine intermediaries. They served in households, military units, and administrative roles.",
      "Byzantium": "The Byzantine Empire absorbed Slavic captives, particularly from South Slavic regions. They worked in households, agriculture, and as soldiers in Byzantine armies."
    }
  },
  {
    "id": "southeast-asian",
    "name": "Southeast Asian Slave Systems",
    "period": "800 - 1900 CE",
    "color": "#a855f7",
    "startYear": 800,
    "endYear": 1900,
    "lowEstimate": 6000000,
    "highEstimate": 9000000,
    "flows": [
      { "source": "Burmese Captives", "destination": "Thai Agriculture", "value": 1500000 },
      { "source": "Thai Captives", "destination": "Burmese Courts", "value": 1000000 },
      { "source": "Khmer Captives", "destination": "Temple Labor", "value": 1800000 },
      { "source": "Indonesian Captives", "destination": "Maritime Labor", "value": 900000 },
      { "source": "Philippine Captives", "destination": "Maritime Labor", "value": 400000 },
      { "source": "Hill Tribes", "destination": "Domestic/Estates", "value": 1400000 }
    ],
    "description": "Southeast Asian kingdoms relied heavily on enslaved or semi-enslaved populations for agriculture, temple construction, military logistics, court life, and maritime raiding. Systems blended political servitude, slavery, and corvée.",
    "ending": "Colonial rule (British, French, Dutch, Spanish) imposed abolition gradually, often replacing slavery with forced labor systems until the 20th century.",
    "destinationDetails": {
      "Thai Agriculture": "Thai rice fields and agricultural estates absorbed large numbers of Burmese war captives, who worked in forced agricultural labor.",
      "Burmese Courts": "Burmese royal courts and temple complexes used Thai captives for construction, domestic service, and ceremonial roles.",
      "Temple Labor": "Khmer Empire temple complexes (like Angkor Wat) relied on massive forced labor for construction and maintenance, drawing from war captives and tribute populations.",
      "Maritime Labor": "Maritime Southeast Asian powers used enslaved people for galley labor, port work, and naval operations. Indonesian and Philippine captives were particularly used in maritime contexts.",
      "Domestic/Estates": "Hill tribes and other marginalized groups were captured and used in domestic service and agricultural estates across Southeast Asian kingdoms."
    }
  },
  {
    "id": "mongol",
    "name": "Mongol & Steppe Imperial Enslavement",
    "period": "1200 - 1400 CE",
    "color": "#b91c1c",
    "startYear": 1200,
    "endYear": 1400,
    "lowEstimate": 4000000,
    "highEstimate": 6000000,
    "flows": [
      { "source": "Northern China", "destination": "Yuan China", "value": 1600000 },
      { "source": "Northern China", "destination": "Central Asia", "value": 400000 },
      { "source": "Central Asia", "destination": "Persia", "value": 600000 },
      { "source": "Central Asia", "destination": "Steppes", "value": 400000 },
      { "source": "Persia", "destination": "Persia", "value": 500000 },
      { "source": "Persia", "destination": "Middle East", "value": 300000 },
      { "source": "Persia", "destination": "Central Asia", "value": 200000 },
      { "source": "Rus'", "destination": "Golden Horde", "value": 400000 },
      { "source": "Rus'", "destination": "Central Asia", "value": 100000 },
      { "source": "Caucasus", "destination": "Persia", "value": 300000 }
    ],
    "description": "Mongol conquests produced one of the largest mass enslavement events in Eurasian history. Survivors of sacked cities were redistributed across the empire as agricultural laborers, artisans, domestic servants, soldiers, and human tribute. Deportations integrated Eurasian populations under Mongol rule.",
    "ending": "Enslavement declined with the fragmentation of the Mongol Empire and stabilization of successor states. Local dynasties restored administrative control, and mass deportations ended as conquest halted.",
    "destinationDetails": {
      "Yuan China": "The Yuan dynasty (Mongol-ruled China) absorbed massive numbers of enslaved people from northern China and other conquered regions. They worked in agriculture, crafts, and imperial service.",
      "Central Asia": "Central Asian steppes and cities received deportees from across the Mongol Empire, who were integrated into local economies and military units.",
      "Persia": "The Ilkhanate (Mongol-ruled Persia) received large numbers of captives from Central Asia, the Caucasus, and Persia itself. They worked in agriculture, crafts, and urban service.",
      "Steppes": "Central Asian steppe regions absorbed deportees who worked as herders, craftspeople, and in military service.",
      "Middle East": "The Middle East received captives through the Ilkhanate, who were integrated into local economies and military units.",
      "Golden Horde": "The Golden Horde (Mongol-ruled Rus' territories) absorbed captives from Rus' principalities, who worked in agriculture, crafts, and military service."
    }
  },
  {
    "id": "crimean",
    "name": "Crimean/Black Sea",
    "period": "1440s - 1783",
    "color": "#06b6d4",
    "startYear": 1440,
    "endYear": 1783,
    "lowEstimate": 1000000,
    "highEstimate": 3000000,
    "flows": [
      { "source": "Ukraine", "destination": "Crimean Markets", "value": 800000 },
      { "source": "Poland-Lithuania", "destination": "Crimean Markets", "value": 600000 },
      { "source": "Russia", "destination": "Ottoman Empire", "value": 700000 },
      { "source": "Balkans", "destination": "Ottoman Empire", "value": 400000 },
      { "source": "Various", "destination": "Middle East", "value": 500000 }
    ],
    "description": "From the 15th to the late 18th century, Crimean Tatar raiders and other groups captured an estimated 1–3 million people from what is now Ukraine, Poland–Lithuania and Russia. Captives were marched to Crimean ports such as Caffa and sold in markets that supplied the Ottoman Empire and the wider Middle East. Many were peasants seized in seasonal raids; some were nobles ransomed back to their families. The trade helped sustain the Crimean Khanate's economy and its ties to Istanbul.",
    "ending": "The trade collapsed when Russian expansion pushed south. Major wars in the 17th–18th centuries weakened the Crimean Khanate, and Russia's annexation of Crimea in 1783 effectively ended large-scale raiding and slave markets there. New borders, fortified frontiers and changing military technology made steppe raids more difficult, while diplomatic pressure from European and Russian powers curtailed the export of Christian captives into the Ottoman world.",
    "destinationDetails": {
      "Crimean Markets": "Ports such as Caffa, Kefe and Gezlev were central sorting points. Captives from Polish–Lithuanian, Ukrainian and Russian lands were branded, recorded and sold to Ottoman and Middle Eastern buyers or ransomed back through church and family networks.",
      "Ottoman Empire": "The Ottoman Empire absorbed large numbers of captives as household servants, agricultural laborers, artisans and, in some cases, soldiers or administrators. Istanbul and other major cities were prime destinations.",
      "Middle East": "Some captives were sent onward from Ottoman ports into the broader Middle East, including Egypt and the Levant, where they entered domestic service, agricultural work or military households."
    }
  },
  {
    "id": "indian-ocean",
    "name": "Indian Ocean Trade",
    "period": "1st - 20th Century",
    "color": "#8b5cf6",
    "startYear": 100,
    "endYear": 1920,
    "lowEstimate": 8000000,
    "highEstimate": 8000000,
    "flows": [
      { "source": "East Africa", "destination": "Arabia", "value": 2000000 },
      { "source": "East Africa", "destination": "Persian Gulf", "value": 1500000 },
      { "source": "East Africa", "destination": "India", "value": 1000000 },
      { "source": "Madagascar", "destination": "Mascarene Islands", "value": 500000 },
      { "source": "Madagascar", "destination": "Red Sea Ports", "value": 300000 },
      { "source": "Horn of Africa", "destination": "Arabia", "value": 800000 },
      { "source": "Zanzibar", "destination": "Ottoman Empire", "value": 900000 },
      { "source": "Various", "destination": "Indian Ocean Islands", "value": 1000000 }
    ],
    "description": "The Indian Ocean slave trade connected East Africa, Madagascar, the Horn and parts of Asia for many centuries. Estimates cluster around 8 million people over the long run, with peaks in the 18th–19th centuries. Enslaved people labored in date plantations and pearl diving in the Gulf, on clove and sugar plantations in islands like Zanzibar and Réunion, as porters and soldiers in East Africa, and as domestic servants and concubines in Arabia, India and the wider Ottoman world. The gender balance skewed heavily toward women and children in many routes.",
    "ending": "This trade declined unevenly. British naval patrols after the early 1800s targeted slave dhows in the western Indian Ocean; treaties with Oman and other Gulf rulers formally outlawed oceanic trafficking. France abolished slavery in the Mascarene Islands in the mid-19th century, and European colonial rule in East Africa restricted public slave markets. Still, systems of domestic slavery and clientage persisted in parts of East Africa, Arabia and the Gulf into the early 20th century, only gradually dismantled by local abolition laws and international pressure.",
    "destinationDetails": {
      "Arabia": "Enslaved Africans and Malagasy were taken to ports like Muscat and Jeddah and dispersed into households, pastoral camps and royal courts across the Arabian Peninsula. Many worked as domestic servants, herders or concubines, with some employed in pilgrimage and caravan services.",
      "Persian Gulf": "In the Gulf, enslaved people worked in pearl diving, date cultivation and urban service in ports like Basra, Kuwait and Bahrain. They formed a crucial labor force for the pearl industry before oil.",
      "India": "Indian ports such as Surat, Goa and Calicut received enslaved Africans and other peoples who were used in domestic service, military units and port labor. Some were integrated into local societies over generations.",
      "Mascarene Islands": "Mauritius, Réunion and other islands developed plantation economies reliant on enslaved Africans, Malagasy and South Asians, first under French and then British rule, producing sugar and other export crops.",
      "Red Sea Ports": "Red Sea ports acted as waypoints where captives from East Africa and the Horn were transshipped to Arabia, Egypt and the Levant. Some remained in local households or coastal estates.",
      "Ottoman Empire": "African captives passing through Red Sea and eastern Mediterranean routes entered Ottoman lands as domestic servants, soldiers, agricultural laborers and palace slaves.",
      "Indian Ocean Islands": "Smaller island societies across the western Indian Ocean used enslaved labor for agriculture, shipping and household work, often blending African, South Asian and local populations over time."
    }
  },
  {
    "id": "barbary",
    "name": "Barbary Corsairs",
    "period": "1500s - 1830s",
    "color": "#a855f7",
    "startYear": 1500,
    "endYear": 1830,
    "lowEstimate": 1000000,
    "highEstimate": 1250000,
    "flows": [
      { "source": "Italy", "destination": "Algiers", "value": 300000 },
      { "source": "Spain", "destination": "Algiers", "value": 250000 },
      { "source": "France", "destination": "Tunis", "value": 150000 },
      { "source": "Britain/Ireland", "destination": "Tripoli", "value": 100000 },
      { "source": "Mediterranean Islands", "destination": "Algiers", "value": 150000 },
      { "source": "Various Europe", "destination": "Morocco", "value": 200000 },
      { "source": "Coastal Raids", "destination": "Barbary Coast", "value": 100000 }
    ],
    "description": "Between the 1500s and early 1800s, Barbary corsairs operating from Algiers, Tunis, Tripoli and Moroccan ports seized European sailors and coastal villagers. Robert Davis's estimates suggest around 1–1.25 million Christian captives over three centuries. Many became galley rowers, dock laborers or domestic servants; others awaited ransom funded by European states, religious orders or families. The system blended piracy, privateering and state revenue.",
    "ending": "Barbary raiding declined as European naval power grew. By the late 18th century, stronger warships, convoy systems and diplomatic pressure limited corsair activity. The United States and European powers launched punitive expeditions, including the bombardment of Algiers in 1816. France's conquest of Algiers in 1830 and subsequent colonization of North Africa dismantled the corsair regimes and ended the legal enslavement of European Christians in the region.",
    "destinationDetails": {
      "Algiers": "Algiers was the most notorious corsair base. Captives were marched through the streets, sold in public markets and assigned to hard labor in quarries, building projects and galleys, or held for ransom in crowded prisons.",
      "Tunis": "In Tunis, enslaved Europeans worked in fortifications, shipyards and elite households. The city profited heavily from ransom payments negotiated with European consuls and religious orders.",
      "Tripoli": "Tripoli served as another corsair haven, with captives forced into harbor work, construction and domestic service while diplomatic missions attempted to buy their freedom.",
      "Morocco": "Moroccan ports such as Salé and Rabat hosted corsair fleets targeting Atlantic shipping. Captives could end up in royal projects, urban labor or remote construction sites.",
      "Barbary Coast": "\"Barbary Coast\" here represents smaller ports and coastal forts that absorbed part of the captive population, redistributing them among local rulers, corsair crews and merchants."
    }
  },
  {
    "id": "red-sea",
    "name": "Red Sea Trade",
    "period": "Ancient - 1962",
    "color": "#ec4899",
    "startYear": -100,
    "endYear": 1962,
    "lowEstimate": 500000,
    "highEstimate": 1000000,
    "flows": [
      { "source": "Ethiopia", "destination": "Hejaz/Mecca", "value": 250000 },
      { "source": "Ethiopia", "destination": "Yemen", "value": 200000 },
      { "source": "Sudan", "destination": "Egypt", "value": 150000 },
      { "source": "Sudan", "destination": "Hejaz", "value": 150000 },
      { "source": "Somalia", "destination": "Arabia", "value": 100000 },
      { "source": "Eritrea", "destination": "Red Sea Ports", "value": 150000 }
    ],
    "description": "The Red Sea trade linked East Africa and the Horn to Egypt, Arabia and the wider Islamic world from antiquity into the 20th century. Estimates suggest at least 500,000–1 million people over the long term, with perhaps half a million in the 19th century alone. Many captives were women and children taken from Ethiopia, Sudan and coastal East Africa, entering domestic service, concubinage, agriculture and pilgrimage support along the Red Sea littoral.",
    "ending": "Because the Red Sea system overlapped with Indian Ocean and Saharan networks, it faded in stages. British pressure on Red Sea shipping, Ottoman and Egyptian decrees against the slave trade, and international treaties gradually restricted legal markets in the 19th century. Nevertheless, covert trafficking into the Arabian Peninsula continued until mid-20th-century abolition decrees—especially Saudi Arabia's and Yemen's bans in 1962—finally made chattel slavery illegal in the region.",
    "destinationDetails": {
      "Egypt": "Egyptian ports such as Suez and Cairo markets took in captives from Sudan, Ethiopia and coastal East Africa. Enslaved people worked in households, estates and Nile agriculture, or were sent onward into the Ottoman world.",
      "Arabia": "Across the Arabian coast, enslaved Africans were integrated into pastoral, urban and religious economies—as domestic servants, herders, porters and concubines. Some supported the pilgrimage traffic to Mecca and Medina.",
      "Hejaz/Mecca": "In the Hejaz, especially Mecca and Medina, enslaved people served in religious institutions, merchant households and services for pilgrims. Many came via Jeddah and other Red Sea ports.",
      "Hejaz": "This label covers the broader western Arabian region, where enslaved Africans worked in towns, oases and caravan support roles.",
      "Yemen": "Yemeni ports and highland towns used enslaved labor in agriculture, coffee production, domestic service and trade, drawing on routes from the Horn of Africa.",
      "Red Sea Ports": "Smaller ports along both African and Arabian shores acted as transit points where captives were sold locally or shipped onward to Egypt, the Levant and the interior."
    }
  },
  {
    "id": "transatlantic",
    "name": "Transatlantic Trade",
    "period": "1500 - 1867",
    "color": "#ef4444",
    "startYear": 1500,
    "endYear": 1867,
    "lowEstimate": 10000000,
    "highEstimate": 12800000,
    "flows": [
      { "source": "West Africa", "destination": "Brazil", "value": 2500000 },
      { "source": "West Africa", "destination": "Caribbean", "value": 2000000 },
      { "source": "West Africa", "destination": "Spanish America", "value": 700000 },
      { "source": "West Africa", "destination": "North America", "value": 300000 },
      { "source": "West-Central Africa", "destination": "Brazil", "value": 2350000 },
      { "source": "West-Central Africa", "destination": "Caribbean", "value": 1650000 },
      { "source": "West-Central Africa", "destination": "Spanish America", "value": 500000 },
      { "source": "Southeast Africa", "destination": "Brazil", "value": 500000 },
      { "source": "Southeast Africa", "destination": "Caribbean", "value": 850000 },
      { "source": "Various Africa", "destination": "Spanish America", "value": 450000 }
    ],
    "description": "The Transatlantic trade moved about 12.5 million Africans onto slave ships; roughly 10.7 million survived to disembark in the Americas. West and West-Central Africa supplied most captives, with Southeast Africa added in the late period. The largest single destination was Brazil, followed by Caribbean sugar islands and Spanish America. Only about 3–4% of captives were landed directly in what became the United States. Mortality on voyages averaged around 12–15%, and many more people died in wars and marches that fed the trade.",
    "ending": "Abolition unfolded in stages. Britain banned its slave trade in 1807 and used the Royal Navy to pressure other powers; the United States banned the transatlantic trade in 1808. Slavery itself was abolished across the British Empire in the 1830s, in French colonies in 1848, in most Spanish American republics between the 1810s–1850s, and in the United States in 1865 after the Civil War. Brazil was the last major slave society in the Americas to abolish slavery in 1888. Illegal trafficking persisted for decades, but by the late 19th century the transatlantic system had been dismantled by legal bans, naval suppression and slave uprisings.",
    "destinationDetails": {
      "Brazil": "Brazil received by far the largest share of enslaved Africans—over 5 million people—feeding sugar, coffee and mining economies from the 16th to 19th centuries. Plantation labor was harsh, with high mortality and constant demand for new imports. Afro-Brazilian cultures deeply shaped language, religion and music.",
      "Caribbean": "The Caribbean islands (British, French, Dutch and Danish) imported more than 4 million Africans for sugar, coffee and other plantations. Brutal work regimes and disease produced extreme mortality and frequent revolts, culminating in the Haitian Revolution and later emancipation movements.",
      "Spanish America": "Spanish America—including Mexico, Central America and northern South America—imported around 1–1.3 million Africans. They worked in mines, plantations, ranches and cities. Manumission, caste systems and regional revolutions created complex Afro-Latin societies.",
      "North America": "British North America and later the United States received roughly 300–400 thousand Africans directly, but the enslaved population grew rapidly through natural increase. Plantation slavery concentrated in the Chesapeake and Deep South, and its destruction required a civil war and constitutional abolition."
    }
  },
  {
    "id": "modern",
    "name": "MODERN SLAVERY",
    "period": "2021 (Current)",
    "color": "#dc2626",
    "startYear": 2021,
    "endYear": 2021,
    "lowEstimate": 49600000,
    "highEstimate": 50000000,
    "flows": [
      { "source": "Asia-Pacific", "destination": "Forced Labor", "value": 13000000 },
      { "source": "Asia-Pacific", "destination": "Forced Marriage", "value": 14300000 },
      { "source": "Europe-C.Asia", "destination": "Forced Labor", "value": 3000000 },
      { "source": "Europe-C.Asia", "destination": "Forced Marriage", "value": 1600000 },
      { "source": "Africa", "destination": "Forced Labor", "value": 2700000 },
      { "source": "Africa", "destination": "Forced Marriage", "value": 3200000 },
      { "source": "Americas", "destination": "Forced Labor", "value": 2500000 },
      { "source": "Americas", "destination": "Forced Marriage", "value": 1100000 },
      { "source": "Arab States", "destination": "Forced Labor", "value": 500000 },
      { "source": "Arab States", "destination": "Forced Marriage", "value": 1100000 },
      { "source": "Global", "destination": "Sex Trafficking", "value": 6300000 },
      { "source": "Various", "destination": "State-Imposed", "value": 3800000 }
    ],
    "description": "In 2021, around 49.6–50 million people were estimated to be in \"modern slavery\": 27.6 million in forced labor and 22 million in forced marriage. These figures come from ILO, Walk Free and IOM modeling based on surveys and administrative data. Modern slavery includes exploitation in private economies, state-imposed labor, and coercive marriages across every region of the world.",
    "ending": "Modern slavery is formally illegal everywhere, but it persists because of conflict, weak labor enforcement, discrimination, migration vulnerability and profit incentives. International conventions (1926 Slavery Convention, 1956 Supplementary Convention, ILO conventions, the Palermo Protocol and national anti-trafficking laws) aim to eliminate it, and some countries have strengthened due-diligence and supply-chain laws. However, prevalence has increased between 2016 and 2021, especially in forced labor and forced marriage, showing that abolition on paper is not yet abolition in practice.",
    "destinationDetails": {
      "Forced Labor": "Forced labor covers people compelled to work under threats, debt or confiscated documents in sectors such as construction, manufacturing, agriculture, domestic work and fishing. Many victims are migrants working abroad without full legal protection.",
      "Forced Marriage": "Forced marriage includes situations where people—disproportionately women and girls—are married without free and informed consent, often facing lifelong domestic and sexual servitude. These arrangements may be framed as \"traditional\" but meet criteria for slavery-like practices.",
      "Sex Trafficking": "Sex trafficking involves the recruitment, transport or harboring of people for sexual exploitation through coercion, deception or abuse of vulnerability. Victims are found in brothels, massage parlors, online platforms and informal venues across all regions.",
      "State-Imposed": "State-imposed forced labor includes compulsory prison labor without due process, abusive conscription systems and forced participation in public works or political programs. Examples include prison camps, forced labor as punishment for dissent, and compulsory labor tied to ethnicity or religion."
    }
  }
];

const SlaveryVisualization = () => {
    const svgRef = useRef(null);
    const tooltipRef = useRef(null);
    const [selectedTrade, setSelectedTrade] = useState(null);
    const [selectedDestination, setSelectedDestination] = useState(null);

    const openTradeDetail = (trade, destination = null) => {
        setSelectedTrade(trade);
        setSelectedDestination(destination);
    };

    useEffect(() => {
        if (svgRef.current) {
            drawVisualization();
        }
    }, []);

    const drawVisualization = () => {
        if (!slaveryData || slaveryData.length === 0) return;

        const margin = { top: 80, right: 300, bottom: 80, left: 250 };
        const trackHeight = 280;
        const width = 2200 - margin.left - margin.right;
        const height = (slaveryData.length * trackHeight) + margin.top + margin.bottom;

        d3.select(svgRef.current).selectAll('*').remove();

        const svg = d3.select(svgRef.current)
            .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height)
            .attr('class', 'timeline-svg')
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        const xScale = d3.scaleLinear()
            .domain([-800, 2025])
            .range([0, width]);

        const gridLines = [];
        for (let year = -800; year <= 2025; year += 100) {
            gridLines.push(year);
        }

        svg.append('g')
            .attr('class', 'grid')
            .selectAll('line')
            .data(gridLines)
            .join('line')
            .attr('x1', d => xScale(d))
            .attr('x2', d => xScale(d))
            .attr('y1', 0)
            .attr('y2', height - margin.top - margin.bottom)
            .attr('stroke', d => d === 0 ? '#666' : '#333')
            .attr('stroke-width', d => d === 0 ? 2 : 1);

        const xAxisTop = d3.axisTop(xScale)
            .tickValues(gridLines)
            .tickFormat(d => d < 0 ? `${Math.abs(d)} BCE` : d === 0 ? '0' : d);

        svg.append('g')
            .attr('class', 'axis')
            .attr('transform', 'translate(0,-25)')
            .call(xAxisTop);

        const xAxisBottom = d3.axisBottom(xScale)
            .tickValues(gridLines)
            .tickFormat(d => d < 0 ? `${Math.abs(d)} BCE` : d === 0 ? '0' : d);

        svg.append('g')
            .attr('class', 'axis')
            .attr('transform', `translate(0,${height - margin.top - margin.bottom})`)
            .call(xAxisBottom);

        const showTooltip = (event, html) => {
            const tooltip = d3.select(tooltipRef.current);
            tooltip.html(html)
                .style('opacity', 1)
                .style('left', (event.pageX + 15) + 'px')
                .style('top', (event.pageY - 15) + 'px');
        };

        const hideTooltip = () => {
            d3.select(tooltipRef.current).style('opacity', 0);
        };

        slaveryData.forEach((trade, index) => {
            const yOffset = index * trackHeight;
            const tradeGroup = svg.append('g')
                .attr('transform', `translate(0,${yOffset})`);

            const startX = xScale(trade.startYear);
            const endX = xScale(trade.endYear);
            // Ensure minimum width for single-year entries (like Modern Slavery)
            const flowWidth = Math.max(endX - startX, 100);
            const flowHeight = trackHeight - 60;

            tradeGroup.append('rect')
                .attr('x', startX)
                .attr('y', 0)
                .attr('width', flowWidth)
                .attr('height', trackHeight)
                .attr('fill', trade.color)
                .attr('opacity', 0.05)
                .attr('rx', 8);

            // Combined title: Name | Estimate | Period, centered at top of colored area
            const titleText = `${trade.name} | ${(trade.lowEstimate/1000000).toFixed(1)}-${(trade.highEstimate/1000000).toFixed(1)}M | ${trade.period}`;
            tradeGroup.append('text')
                .attr('class', 'trade-title')
                .attr('x', startX + flowWidth / 2)
                .attr('y', 15)
                .attr('text-anchor', 'middle')
                .attr('fill', trade.color)
                .attr('font-weight', '600')
                .attr('font-size', '14px')
                .text(titleText);

            const totalValue = trade.flows.reduce((sum, flow) => sum + flow.value, 0);

            const destinationTotals = {};
            trade.flows.forEach(flow => {
                if (!destinationTotals[flow.destination]) destinationTotals[flow.destination] = 0;
                destinationTotals[flow.destination] += flow.value;
            });

            const destinations = Object.keys(destinationTotals);
            const nodeWidth = 15;
            const nodePadding = 5;

            // Group flows by destination to calculate stacking positions
            const flowsByDestination = {};
            trade.flows.forEach(flow => {
                if (!flowsByDestination[flow.destination]) flowsByDestination[flow.destination] = [];
                flowsByDestination[flow.destination].push(flow);
            });

            const destPositions = {};
            const destFlowPositions = {}; // Track flow positions within each destination
            let cumulativeDestY = 40;
            destinations.forEach(dest => {
                const destHeightProp = (destinationTotals[dest] / totalValue) * flowHeight * 0.7;
                
                // Calculate positions for flows within this destination - stack them vertically
                const destFlows = flowsByDestination[dest];
                let destFlowY = cumulativeDestY;
                destFlowPositions[dest] = [];
                
                destFlows.forEach(flow => {
                    const flowHeightProp = (flow.value / destinationTotals[dest]) * destHeightProp;
                    destFlowPositions[dest].push({
                        source: flow.source,
                        value: flow.value,
                        y: destFlowY,
                        height: flowHeightProp,
                        midY: destFlowY + flowHeightProp / 2
                    });
                    destFlowY += flowHeightProp;
                });
                
                destPositions[dest] = {
                    y: cumulativeDestY,
                    height: destHeightProp,
                    midY: cumulativeDestY + destHeightProp / 2
                };
                cumulativeDestY += destHeightProp + nodePadding;
            });

            // For single-year entries, ensure nodes are positioned correctly
            const actualEndX = trade.startYear === trade.endYear ? startX + flowWidth : endX;
            const endXNode = actualEndX - 30;
            const destLabelX = actualEndX + 30; // Position labels outside colored area

            destinations.forEach(dest => {
                const pos = destPositions[dest];
                tradeGroup.append('rect')
                    .attr('class', 'dest-node')
                    .attr('x', endXNode)
                    .attr('y', pos.y)
                    .attr('width', nodeWidth)
                    .attr('height', pos.height)
                    .attr('fill', trade.color)
                    .attr('opacity', 0.9)
                    .attr('rx', 3)
                    .style('cursor', 'pointer')
                    .on('click', () => openTradeDetail(trade, dest))
                    .on('mouseover', function(event) {
                        d3.select(this).attr('opacity', 1).attr('filter', 'brightness(1.3)');
                        showTooltip(event, `<strong>${dest}</strong><br/>${(destinationTotals[dest]/1000000).toFixed(2)}M people`);
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('opacity', 0.9).attr('filter', null);
                        hideTooltip();
                    });

                tradeGroup.append('text')
                    .attr('class', 'node-label')
                    .attr('x', destLabelX)
                    .attr('y', pos.midY)
                    .attr('dy', '0.35em')
                    .attr('text-anchor', 'start')
                    .text(`${dest} (${(destinationTotals[dest]/1000000).toFixed(1)}M)`);
            });

            const sourceGroups = {};
            trade.flows.forEach(flow => {
                if (!sourceGroups[flow.source]) sourceGroups[flow.source] = [];
                sourceGroups[flow.source].push(flow);
            });

            const sourceTotals = {};
            Object.keys(sourceGroups).forEach(source => {
                sourceTotals[source] = sourceGroups[source].reduce((sum, f) => sum + f.value, 0);
            });

            let cumulativeSourceY = 40;
            // Position source nodes at the left edge of the colored area
            const sourceNodeX = trade.startYear === trade.endYear ? startX + 5 : startX + 10;

            Object.entries(sourceGroups).forEach(([source, group]) => {
                // Calculate individual flow heights based on their values
                const segmentHeights = group.map(f => (f.value / totalValue) * flowHeight * 0.7);
                
                // Source node height is the sum of all flow heights (ensures perfect match)
                const sourceHeight = segmentHeights.reduce((a, b) => a + b, 0);

                // Create ONE unified source node for this source group
                tradeGroup.append('rect')
                    .attr('class', 'source-node')
                    .attr('x', sourceNodeX)
                    .attr('y', cumulativeSourceY)
                    .attr('width', nodeWidth)
                    .attr('height', sourceHeight)
                    .attr('fill', trade.color)
                    .attr('opacity', 0.8)
                    .attr('rx', 3)
                    .on('mouseover', function(event) {
                        d3.select(this).attr('opacity', 1).attr('filter', 'brightness(1.3)');
                        showTooltip(
                            event,
                            `<strong>${source}</strong><br/>${(sourceTotals[source]/1000000).toFixed(2)}M people total`
                        );
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('opacity', 0.8).attr('filter', null);
                        hideTooltip();
                    });

                // Now draw individual flows from the unified source to each destination
                let localY = cumulativeSourceY;

                group.forEach((flow, idx) => {
                    const flowHeightProp = segmentHeights[idx];
                    const sourceY = localY;
                    const sourceMidY = sourceY + flowHeightProp / 2;

                    const destPos = destPositions[flow.destination];
                    
                    // Find the position for this specific flow within the destination
                    // Match by source and approximate value/height
                    const destFlows = destFlowPositions[flow.destination] || [];
                    let destFlowMidY = destPos.midY; // fallback to center
                    
                    // Find matching flow position by source and value
                    const matchingPos = destFlows.find(pos => 
                        pos.source === flow.source && 
                        Math.abs(pos.value - flow.value) < 1000 // Match by value
                    );
                    
                    if (matchingPos) {
                        destFlowMidY = matchingPos.midY;
                    } else if (destFlows.length > 0) {
                        // If no exact match, use the first unmatched position
                        destFlowMidY = destFlows[0].midY;
                    }

                    const path = d3.path();
                    path.moveTo(sourceNodeX + nodeWidth, sourceMidY);

                    const controlPoint1X = startX + flowWidth * 0.3;
                    const controlPoint2X = startX + flowWidth * 0.7;

                    path.bezierCurveTo(
                        controlPoint1X, sourceMidY,
                        controlPoint2X, destFlowMidY,
                        endXNode, destFlowMidY
                    );

                    tradeGroup.append('path')
                        .attr('class', 'flow-path')
                        .attr('d', path.toString())
                        .attr('stroke', trade.color)
                        .attr('stroke-width', Math.max(1, flowHeightProp))
                        .attr('fill', 'none')
                        .attr('stroke-opacity', 0.3)
                        .on('mouseover', function(event) {
                            d3.select(this).attr('stroke-opacity', 0.9).attr('filter', 'brightness(1.5)');
                            showTooltip(
                                event,
                                `<strong>${flow.source} → ${flow.destination}</strong><br/>${(flow.value/1000000).toFixed(2)}M people`
                            );
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('stroke-opacity', 0.3).attr('filter', null);
                            hideTooltip();
                        });

                    localY += flowHeightProp;
                });

                const midY = cumulativeSourceY + sourceHeight / 2;
                const sourceLabelX = startX - 30; // Position labels outside colored area
                tradeGroup.append('text')
                    .attr('class', 'node-label')
                    .attr('x', sourceLabelX)
                    .attr('y', midY)
                    .attr('dy', '0.35em')
                    .attr('text-anchor', 'end')
                    .text(`${source} (${(sourceTotals[source]/1000000).toFixed(1)}M)`);

                cumulativeSourceY += sourceHeight + nodePadding;
            });
        });
    };

    const formatNumber = (num) => {
        if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
        return num.toLocaleString();
    };

    const totalHistorical = slaveryData
        .filter(d => d.id !== 'modern')
        .reduce((sum, d) => sum + (d.highEstimate + d.lowEstimate) / 2, 0);

    return (
        <div className="container">
            <h1>The Scale of Slavery Throughout History</h1>
            <p className="subtitle">
                An integrated timeline visualization showing sources, flows, and destinations of enslaved people from Ancient Rome to the present day. "all models are wrong, some are useful", the numbers here are based on historical consensus, but data is sometime sparse and incomplete. It is certainly directionality accurate, despite your nitpick.
            </p>

            <div className="stats-banner">
                <div className="stat-card" style={{ borderLeftColor: '#dc2626' }}>
                    <h3>Modern Slavery (2021)</h3>
                    <div className="number">50M</div>
                    <div className="context">People enslaved RIGHT NOW</div>
                </div>
                <div className="stat-card" style={{ borderLeftColor: '#ef4444' }}>
                    <h3>Transatlantic Trade</h3>
                    <div className="number">12.8M</div>
                    <div className="context">Maximum estimate (1500-1867)</div>
                </div>
                <div className="stat-card" style={{ borderLeftColor: '#f59e0b' }}>
                    <h3>Trans-Saharan Trade</h3>
                    <div className="number">10M</div>
                    <div className="context">Over 1,300 years (650-1900)</div>
                </div>
                <div className="stat-card" style={{ borderLeftColor: '#14b8a6' }}>
                    <h3>Historical Total</h3>
                    <div className="number">{formatNumber(totalHistorical)}</div>
                    <div className="context">Approximate total (all historical trades)</div>
                </div>
            </div>

            <div className="visualization-container">
                <div ref={svgRef}></div>
                <div className="legend">
                    {slaveryData.map(trade => (
                        <div key={trade.id} className="legend-item">
                            <div className="legend-color" style={{ background: trade.color }}></div>
                            <span>{trade.name} ({trade.period})</span>
                        </div>
                    ))}
                </div>
            </div>

            <div ref={tooltipRef} className="tooltip"></div>

            <div className={`detail-modal ${selectedTrade ? 'visible' : ''}`} onClick={(e) => {
                if (e.target.className.includes('detail-modal')) {
                    setSelectedTrade(null);
                    setSelectedDestination(null);
                }
            }}>
                {selectedTrade && (
                    <div className="detail-content">
                        <button className="close-modal-btn" onClick={() => { setSelectedTrade(null); setSelectedDestination(null); }}>
                            Close
                        </button>
                        <h2 style={{ color: selectedTrade.color }}>{selectedTrade.name}</h2>
                        <p><strong>Period:</strong> {selectedTrade.period}</p>
                        <p><strong>Estimated Scale:</strong> {formatNumber(selectedTrade.lowEstimate)} - {formatNumber(selectedTrade.highEstimate)} people</p>
                        <hr style={{ margin: '20px 0', border: 'none', borderTop: '1px solid #333' }}/>
                        {selectedDestination && selectedTrade.destinationDetails && selectedTrade.destinationDetails[selectedDestination] && (
                            <>
                                <h3>Destination: {selectedDestination}</h3>
                                <p>{selectedTrade.destinationDetails[selectedDestination]}</p>
                                <hr style={{ margin: '20px 0', border: 'none', borderTop: '1px solid #333' }}/>
                            </>
                        )}
                        <p>{selectedTrade.description}</p>
                        {selectedTrade.ending && (
                            <>
                                <h3 style={{ marginTop: '1.5rem' }}>End of this system</h3>
                                <p>{selectedTrade.ending}</p>
                            </>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
};

ReactDOM.render(<SlaveryVisualization />, document.getElementById('root'));
</script>
</body>
</html>
